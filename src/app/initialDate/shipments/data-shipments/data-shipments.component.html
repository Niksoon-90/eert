<ng-container *ngIf="!this.loading; else shipSession">
  <div class="p-mb-3" style="margin: 20px 0 0 0 !important;">
    <p-button type="button" icon="pi pi-chevron-left" (click)="prev()" [disabled]="isFirstPage()" styleClass="p-button-text"></p-button>
    <p-button type="button" icon="pi pi-refresh" (click)="reset()" styleClass="p-button-text" pTooltip="Обновить" tooltipPosition="bottom"></p-button>
    <p-button type="button" icon="pi pi-chevron-right" (click)="next()" [disabled]="isLastPage()" styleClass="p-button-text"></p-button>
  </div>
  <p-table [value]="shipmentsSession"
           styleClass="p-datatable-sm p-datatable-gridlines"
           [scrollable]="true" scrollHeight="flex" scrollHeight="75vh"
           [paginator]="true" [rows]="rows"
           [showCurrentPageReport]="true" [(first)]="first"
           currentPageReportTemplate=" {first} из {last}  ({totalRecords})" [rowsPerPageOptions]="[25,50]" dataKey="id"
           [resizableColumns]="true">
    <ng-template pTemplate="colgroup" let-columns>
      <colgroup>
        <col style="width:80px">
        <col>
        <col>
        <col>
        <col>
        <col>
        <col style="width:100px">
      </colgroup>
    </ng-template>
    <ng-template pTemplate="header">
      <tr >
        <th pResizableColumn pSortableColumn="id">id<p-sortIcon field="id"></p-sortIcon></th>
        <th pResizableColumn pSortableColumn="name">Наименование<p-sortIcon field="name"></p-sortIcon></th>
        <th pResizableColumn pSortableColumn="year">Года<p-sortIcon field="year"></p-sortIcon></th>
        <th pResizableColumn pSortableColumn="userLoginAdd">Логин<p-sortIcon field="userLoginAdd"></p-sortIcon></th>
        <th pResizableColumn pSortableColumn="userFioAdd">ФИО<p-sortIcon field="userFioAdd"></p-sortIcon></th>
        <th pResizableColumn pSortableColumn="dateWrite">Дата загрузки<p-sortIcon field="endDate"></p-sortIcon></th>
        <th> Действия</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-itemShipmentsSession >
      <tr>
        <td>{{itemShipmentsSession.id}}</td>
        <td>{{itemShipmentsSession.name}}</td>
        <td>{{itemShipmentsSession.year}}</td>
        <td>{{itemShipmentsSession.userLoginAdd}}</td>
        <td>{{itemShipmentsSession.userFioAdd}}</td>
        <td>{{itemShipmentsSession.dateWrite | date:'full' }}</td>
        <td>
          <button pButton pRipple icon="pi pi-pencil"  class="p-button-rounded p-button-text" type="button" icon="pi pi-pencil" pTooltip="Редактировать" tooltipPosition="bottom"  (click)="openShipItemSession(itemShipmentsSession.id)"></button>
          <button pButton pRipple icon="pi pi-pencil"  class="p-button-rounded p-button-text p-button-danger" type="button" icon="pi pi-trash"  pTooltip="Удалить" tooltipPosition="bottom" (click)="removeShipSession(itemShipmentsSession.id)"></button>
        </td>
      </tr>
    </ng-template>
  </p-table>
</ng-container>

<ng-template #shipSession>
  <div class="p-d-flex p-jc-center" style="height: 80vh">
    <div class="p-grid p-ai-center vertical-container ">
      <p-progressSpinner [style]="{width: '50px', height: '50px'}" styleClass="custom-spinner" strokeWidth="8" fill="#EEEEEE" animationDuration="1s"></p-progressSpinner>
    </div>
  </div>
</ng-template>

<div class="card" *ngIf="mathematicalForecastTable;">
  <p-dialog header="Загруженные данные" [(visible)]="dialogVisible" [style]="{width: '50vw'}" [baseZIndex]="1" [maximizable]="true" [modal]="true" [resizable]="true" [contentStyle]="{height: '90vh'}" >
    <p-table #dt
             [columns]="cols"
             [value]="mathematicalForecastTable"
             [scrollable]="true" scrollHeight="flex" scrollHeight="75vh"
             styleClass="p-datatable-sm p-datatable-gridlines"  dataKey="id" [style]="{width:'94.7vw'}"
             [resizableColumns]="true"  editMode="row"
             [paginator]="true"
             [rows]="1500"
             [totalRecords]="totalRecords"
             [filterDelay]="0"
             (onFilter)="massSummYears($event)"

    >
      <ng-template pTemplate="colgroup" let-columns>
        <colgroup>
          <col style="width:80px" >
          <col *ngFor="let col of columns" [style.width]="col.width" >
          <col style="width:80px" >
        </colgroup>
      </ng-template>
      <ng-template pTemplate="header" let-columns>
        <tr>
          <th></th>
          <th *ngFor="let col of columns;" >
            <ng-container *ngIf="col['field'] !== 'primary'; else prime">
              <input pInputText type="text" (click)="$event.stopPropagation()"  (input)="columnFilter($event, col.field)" class="p-column-filter">
            </ng-container>
            <ng-template #prime>
                <p-dropdown appendTo="body" [options]="primeryBol" [(ngModel)]="selectedPrimery" (onChange)="dt.filter($event.value, col.field, 'equals')"></p-dropdown>
            </ng-template>
          </th>
          <th></th>
        </tr>
        <tr>
          <th pResizableColumn >№</th>
            <th pResizableColumn *ngFor="let col of columns" [pSortableColumn]="col.field"> <p-sortIcon [field]="col.field"></p-sortIcon>
                {{col.header}}
            </th>
          <th>Действия</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-rowData let-columns="columns" let-ri="rowIndex" let-editing="editing">
        <tr [pEditableRow]="rowData">
          <td>{{ri}}</td>
          <td pEditableColumn *ngFor="let col of this.cols; let idx = index">
            <p-cellEditor>
              <ng-template pTemplate="input">
                <input pInputText type="text" [ngModel]="rowData | field:col" (ngModelChange)="editColumn(rowData, col, $event)">
              </ng-template>
              <ng-template pTemplate="output" >
                <div *ngIf="idx < 13 && col['field'] !== 'primary'">
                  {{rowData[col.field]}}
                </div>
                <div *ngIf="col['field'] === 'primary'">
                  <ng-container *ngIf="rowData[col.field] === true; else primaryFalse">
                    да
                  </ng-container>
                  <ng-template #primaryFalse>
                    нет
                  </ng-template>
                </div>
                <div *ngIf="idx > 12" [ngStyle]="{'color': colorYears(rowData, col) == true ? '#c54747' : '#4d7d4d' }">
                  {{rowData | field:col}}
                </div>
              </ng-template>
            </p-cellEditor>
          </td>

          <td style="text-align:center">
            <button *ngIf="!editing" pButton pRipple type="button" pInitEditableRow icon="pi pi-pencil" (click)="onRowEditInit(rowData)" class="p-button-rounded p-button-text"></button>
            <button *ngIf="editing" pButton pRipple type="button" pSaveEditableRow icon="pi pi-check" (click)="onRowEditSave(rowData)" class="p-button-rounded p-button-text p-button-success p-mr-2"></button>
            <button *ngIf="editing" pButton pRipple type="button" pCancelEditableRow icon="pi pi-times" (click)="onRowEditCancel()" class="p-button-rounded p-button-text p-button-danger"></button>
          </td>
        </tr>
      </ng-template>
      <ng-template pTemplate="footer">
        <tr>
          <td colspan="14" class="p-text-right">Итого: </td>
          <td *ngFor="let items of this.massSummYear">{{items | number}}</td>
        </tr>
      </ng-template>
    </p-table>
    <ng-template pTemplate="footer">
      <button type="button" pButton pRipple icon="pi pi-times" (click)="dialogVisible=false" label="Закрыть" class="p-button-text"></button>
    </ng-template>
  </p-dialog>
  </div>
